# Alfa Robot Vision System - TODO List

## 1. 核心算法升级 (Core Algorithm Upgrade)

### 1.1 智能吸取点决策 (Smart Grasping Patch)
不再单纯依赖几何中心或边缘角度，而是基于“吸取窗口评分”机制。
- [ ] **网格化评分**：将箱子表面划分为 $N \times M$ 网格（网格尺寸 $\approx$ 吸盘尺寸）。
- [ ] **平整度检测**：计算每个网格内的深度/法向量方差，剔除褶皱、胶带或破损区域。
- [ ] **重心加权**：距离箱子几何中心越近的网格得分越高。
- [ ] **决策输出**：输出得分最高的网格中心作为 `target_pose`，并在此基础上微调 Yaw 角以避开边缘。

### 1.2 进刀与托盘策略 (Approach & Pallet Strategy)
基于托盘**仅有Z轴自由度**的硬件约束，调整动作逻辑。
- [ ] **Side Pull (侧拉)**：
    - **托盘位姿**：Z轴高度低于箱子底面 1-2cm，位置紧贴货架边缘（作为被动承接平台）。
    - **进刀点**：箱子前表面中心 + 法向量外推 2cm（近距离吸附）。
    - **动作链**：吸附 -> 机械臂水平后退（拖拽） -> 箱子滑入托盘。
- [ ] **Top Pick (顶吸)**：
    - **托盘位姿**：降至适合接料的高度（或最低点）。
    - **进刀点**：最佳吸取块中心 + Z轴向上 5cm（预备点）。
    - **动作链**：吸附 -> 垂直提升（脱离摩擦） -> 水平搬运至托盘上方 -> 释放。

## 2. 全局状态管理 (World State Manager)

从“单帧检测”升级为“持续追踪”，解决箱子 ID 跳变和任务规划问题。

### 2.1 数据结构与关联
- [ ] **BoxInstance 类**：存储 `id`, `world_position` (Map Frame), `dimensions`, `status` (UNPICKED/PICKING/DONE), `confidence`.
- [ ] **数据关联 (Data Association)**：
    - 将每帧检测结果转换到世界坐标系。
    - 基于欧氏距离匹配现有箱子：
        - 匹配成功：更新坐标（加权平均），增加置信度。
        - 匹配失败：若距离 > 阈值且置信度高，创建新 ID。
- [ ] **防抖动/过滤**：设置“连续 N 帧检测到才确认为有效箱子”的逻辑。

### 2.2 任务规划 (Task Planning)
- [ ] **待办清单 (To-Do List)**：维护所有状态为 `UNPICKED` 的箱子列表。
- [ ] **动态排序**：每次抓取前重新排序，策略示例：
    1.  Z 轴最高的优先（防止塌垛）。
    2.  同层中，距离机器最近的优先（X 轴最小）。
- [ ] **状态流转**：提供 API 更新箱子状态（如机械臂反馈“抓取成功”后，将状态置为 `DONE`）。

## 3. 视觉伺服完善 (Visual Servo Refinement)

### 3.1 误差计算 (Error Calculation)
- [ ] **Face Align**：实现基于法向量的 Pitch/Yaw 误差计算，确保吸盘平面平行于箱面。
- [ ] **Top Align**：在选定吸取网格内，计算局部平面的法向量偏差。

### 3.2 异常处理 (Exception Handling)
- [ ] **Target Lost**：伺服过程中若目标丢失，进入“悬停搜索”或“回退重试”状态，而非直接退出。
- [ ] **Safety Stop**：检测到异常深度突变（如有人手介入）时紧急停止。

## 4. 工程化与测试 (Engineering & Testing)

- [ ] **TF 树完善**：在 Launch 文件中移除临时的静态 TF，对接真实的机器人 URDF。
- [ ] **参数动态配置**：支持在运行时通过 `rqt_reconfigure` 调整 `layer_threshold`, `confidence`, `grasp_offset` 等参数。
- [ ] **真机联调**：
    - 验证坐标转换精度（手眼标定误差）。
    - 测试侧拉时托盘与箱子的物理交互（是否会卡住）。
